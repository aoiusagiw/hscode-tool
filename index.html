<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HS Code 申報要素</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- 佈局設定 (Google 翻譯風格) --- */
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: 'Roboto', 'Noto Sans TC', sans-serif; background: #fff; overflow: hidden; }
        
        /* 頂部導航列模擬 */
        .navbar { height: 60px; border-bottom: 1px solid #dadce0; display: flex; align-items: center; padding: 0 24px; }
        .nav-title { font-size: 22px; color: #5f6368; display: flex; align-items: center; gap: 10px; }
        
        /* 主容器：左右兩欄 */
        .container { display: flex; height: calc(100vh - 60px); width: 100%; }
        
        /* 左欄 (輸入) */
        .pane-left { flex: 1; border-right: 1px solid #dadce0; display: flex; flex-direction: column; position: relative; }
        /* 右欄 (輸出) */
        .pane-right { flex: 1; background-color: #f8f9fa; display: flex; flex-direction: column; position: relative; overflow-y: auto; }

        /* 輸入框樣式 */
        textarea {
            flex: 1; width: 100%; border: none; outline: none; resize: none;
            padding: 40px; font-size: 24px; line-height: 1.6; color: #3c4043;
            font-family: inherit; box-sizing: border-box;
        }
        textarea::placeholder { color: #9aa0a6; }

        /* --- 輸出內容表格化 (解決沒對齊的問題) --- */
        .output-content { padding: 40px; }

        /* 表格樣式 */
        .result-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .result-table th, .result-table td { padding: 12px 16px; text-align: left; border-bottom: 1px solid #eee; font-size: 16px; }
        .result-table th { background-color: #f1f3f4; width: 120px; color: #5f6368; font-weight: 500; white-space: nowrap; }
        .result-table td { color: #202124; line-height: 1.6; }
        .result-table tr:last-child td, .result-table tr:last-child th { border-bottom: none; }

        /* 標題樣式 */
        .section-title { font-size: 14px; font-weight: 700; color: #1a73e8; margin: 20px 0 10px 0; text-transform: uppercase; letter-spacing: 0.5px; }

        /* 複製按鈕 */
        .btn-copy {
            position: absolute; top: 15px; right: 20px; z-index: 10;
            background: #fff; border: 1px solid #dadce0; color: #1a73e8;
            padding: 8px 16px; border-radius: 4px; font-size: 14px; font-weight: 500;
            cursor: pointer; display: flex; align-items: center; gap: 5px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .btn-copy:hover { background-color: #f1f8ff; border-color: #d2e3fc; }
        .btn-copy.copied { background-color: #e6f4ea; color: #137333; border-color: transparent; }

        /* 載入動畫 */
        .loading-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.8); display: none;
            justify-content: center; align-items: center; flex-direction: column;
            backdrop-filter: blur(2px); z-index: 20;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #1a73e8; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

<div class="navbar">
    <div class="nav-title">
        <span style="color:#4285f4; font-weight:bold;">HS</span> Code 申報要素助手
    </div>
</div>

<div class="container">
    <div class="pane-left">
        <textarea id="inputData" placeholder="請在此貼上貨物資料...&#10;&#10;例如：&#10;品名：六角螺絲&#10;材質：不鏽鋼"></textarea>
    </div>

    <div class="pane-right">
        <button id="btnCopy" class="btn-copy" onclick="copyResult()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2-2v1"></path></svg>
            複製內容
        </button>

        <div id="outputContent" class="output-content">
            <div style="color:#777; margin-top:20px;">等待輸入... (貼上文字後自動查詢)</div>
        </div>

        <div id="loading" class="loading-overlay">
            <div class="spinner"></div>
            <div style="margin-top:15px; color:#5f6368; font-weight:500;">AI 正在分析歸類中...</div>
        </div>
    </div>
</div>

<script>
    const inputArea = document.getElementById('inputData');
    const outputDiv = document.getElementById('outputContent');
    const loading = document.getElementById('loading');
    const copyBtn = document.getElementById('btnCopy');
    
    // 全域變數儲存原始文字供複製用
    let rawResultText = "";

    // 自動執行
    inputArea.addEventListener('paste', () => {
        setTimeout(() => { if(inputArea.value.trim().length > 1) analyze(); }, 500);
    });

    async function analyze() {
        const input = inputArea.value;
        if (!input.trim()) return;

        loading.style.display = "flex";
        
        try {
            // ★★★ 請記得換成您的 Worker 網址 ★★★
            const workerUrl = "https://hscode-api.kabawang.workers.dev/"; 
            
            const response = await fetch(workerUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ productInfo: input })
            });

            const data = await response.json();

            if (data.result) {
                rawResultText = data.result;
                // 呼叫美化函數 (把文字變表格)
                outputDiv.innerHTML = formatToTable(data.result);
            } else {
                outputDiv.innerHTML = `<div style="color:red; padding:20px;">發生錯誤：${data.error || "未知錯誤"}</div>`;
            }
        } catch (e) {
            outputDiv.innerHTML = `<div style="color:red; padding:20px;">
                <strong>連線失敗 (Failed to fetch)</strong><br><br>
                請檢查：<br>
                1. 阿里雲 DashScope 服務是否已點擊【開通服務】？<br>
                2. Worker 網址是否正確？<br>
                3. 錯誤訊息：${e}
            </div>`;
        } finally {
            loading.style.display = "none";
        }
    }

    // ★ 魔術函數：將 AI 的文字轉換成整齊的表格
    function formatToTable(text) {
        // 簡單的 HTML 產生器
        let html = '';
        const lines = text.split('\n');
        let inTable = false;

        lines.forEach(line => {
            line = line.trim();
            if (!line) return;

            // 判斷是否為標題 (例如 "申報要素：")
            if (line.endsWith('：') || line.endsWith(':')) {
                if (inTable) { html += '</table>'; inTable = false; }
                html += `<div class="section-title">${line}</div>`;
            } 
            // 判斷是否為鍵值對 (例如 "品名：螺絲")
            else if (line.includes('：') || line.includes(':')) {
                if (!inTable) { html += '<table class="result-table">'; inTable = true; }
                
                // 切割 "品名" 和 "螺絲"
                const separator = line.includes('：') ? '：' : ':';
                const parts = line.split(separator);
                const key = parts[0];
                const val = parts.slice(1).join(separator); // 避免內容裡也有冒號

                html += `<tr><th>${key}</th><td>${val}</td></tr>`;
            } 
            // 普通文字
            else {
                if (inTable) { html += '</table>'; inTable = false; }
                html += `<p>${line}</p>`;
            }
        });

        if (inTable) html += '</table>';
        return html;
    }

    // 複製功能
    function copyResult() {
        if (!rawResultText) return;
        navigator.clipboard.writeText(rawResultText).then(() => {
            const originalHTML = copyBtn.innerHTML;
            copyBtn.innerHTML = `✅ 已複製`;
            copyBtn.classList.add('copied');
            setTimeout(() => {
                copyBtn.innerHTML = originalHTML;
                copyBtn.classList.remove('copied');
            }, 2000);
        });
    }
</script>

</body>
</html>
